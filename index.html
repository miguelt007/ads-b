<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informações de Aeronaves com Mapa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.css"/>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            display: flex;
            flex-grow: 1;
            gap: 20px;
            flex-wrap: wrap;
        }
        #map {
            flex: 2;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-width: 300px;
        }
        .table-container {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            min-width: 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
            white-space: nowrap;
        }
        th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            position: relative;
            padding-right: 25px;
        }
        th:hover {
            background-color: #0056b3;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Novas Cores de fundo para as linhas da tabela baseada na altitude (11 níveis + desconhecido) */
        .altitude-level-0 { background-color: #ffe0b2; } /* Laranja muito claro (0 ft) */
        .altitude-level-1 { background-color: #ffcc80; } /* Laranja claro (1-500 ft) */
        .altitude-level-2 { background-color: #ffb74d; } /* Laranja médio (501-1000 ft) */
        .altitude-level-3 { background-color: #fff176; } /* Amarelo muito claro (1001-2000 ft) */
        .altitude-level-4 { background-color: #ffee58; } /* Amarelo claro (2001-4000 ft) */
        .altitude-level-5 { background-color: #ffeb3b; } /* Amarelo médio (4001-6000 ft) */
        .altitude-level-6 { background-color: #c8e6c9; } /* Verde muito claro (6001-8000 ft) */
        .altitude-level-7 { background-color: #a5d6a7; } /* Verde claro (8001-10000 ft) */
        .altitude-level-8 { background-color: #81c784; } /* Verde médio (10001-20000 ft) */
        .altitude-level-9 { background-color: #bbdefb; } /* Azul muito claro (20001-30000 ft) */
        .altitude-level-10 { background-color: #90caf9; } /* Azul claro (30001-40000 ft) */
        .altitude-level-11 { background-color: #f8bbd0; } /* Rosa muito claro (> 40000 ft) */
        .altitude-unknown { background-color: #f0f0f0; } /* Cinza claro */

        tr:hover {
            background-color: #ddd !important; /* !important para sobrepor as cores de altitude no hover */
        }
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            #map {
                width: 100%;
                height: 600px;
            }
            .table-container {
                width: 100%;
            }
            th, td {
                padding: 6px;
            }
        }

        /* CSS para o ícone de avião com texto */
        .aircraft-label-container {
            display: flex;
            align-items: center;
            border-radius: 4px;
            padding: 2px 6px;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            transition: background-color 0.3s ease;
        }
        .aircraft-label-container img {
            display: block;
            width: 24px;
            height: 24px;
            margin-right: 4px;
            transition: transform 0.3s ease-out;
        }
        .aircraft-label-container .flight-text {
            font-size: 0.8em;
            font-weight: bold;
            color: #333;
        }

        /* CSS para o filtro */
        .filter-container {
            margin-bottom: 15px;
            text-align: right;
        }
        .filter-container input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
        }

        /* ESTILOS PARA SETAS DE ORDENAÇÃO */
        .sort-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
        }
        .sort-asc::after {
            content: " ▲";
            color: yellow;
        }
        .sort-desc::after {
            content: " ▼";
            color: yellow;
        }
        th:not(.sort-asc):not(.sort-desc) .sort-arrow::after {
            content: " ▼";
            color: rgba(255, 255, 255, 0.4);
        }

        /* NOVO CSS para a legenda */
        .info.legend {
            align: bottom;
            background: white;
            padding: 6px 8px;
            line-height: 18px;
            color: #555;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .info.legend i {
            align: bottom;
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border-radius: 3px; /* Bordas arredondadas para as amostras de cor */
        }
    </style>
</head>
<body>
    <h1>Localização e Detalhes de Aeronaves</h1>

    <div class="container">
        <div id="map"></div>
        <div class="table-container">
            <h2>Tabela de Voos</h2>

            <div class="filter-container">
                <input type="text" id="tableFilter" placeholder="Filtrar tabela...">
            </div>

            <table id="aircraftTable">
                <thead>
                    <tr>
                        <th data-column="hex">HEX <span class="sort-arrow"></span></th>
                        <th data-column="flight">Callsign <span class="sort-arrow"></span></th>
                        <th data-column="r">Registro <span class="sort-arrow"></span></th>
                        <th data-column="t">Modelo <span class="sort-arrow"></span></th>
                        <th data-column="alt_baro">Alt.(ft) <span class="sort-arrow"></span></th>
                        <th data-column="gs">GS (kt) <span class="sort-arrow"></span></th>
                        <th data-column="type">Source <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>

    <script>
        // *** IMPORTANTE: Substitua estes valores pelas suas credenciais RapidAPI ***
        const RAPIDAPI_KEY = 'dbcf86698cmshd04b1b46934dd15p11474ejsn267bbdb81678';
        const RAPIDAPI_HOST = 'aircraftscatter.p.rapidapi.com';

        // URL da API que você forneceu, com latitude e longitude de Oeiras
        const API_URL = 'https://aircraftscatter.p.rapidapi.com/lat/38.6892887/lon/-9.311829/';

        // Variável global para armazenar os dados das aeronaves
        let allAircraftData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' ou 'desc'

        let map;
        let aircraftMarkers;

        // NOVO: Definição das faixas de altitude e suas cores (11 níveis + desconhecido)
        // Cores em ordem: Laranja (3 tons), Amarelo (3 tons), Verde (3 tons), Azul (2 tons), Rosa (1 tom)
        const altitudeRanges = [
            { threshold: 0, label: '0 ft', colorClass: 'altitude-level-0', colorRgba: 'rgba(255, 224, 178, 0.8)' },          // Laranja muito claro
            { threshold: 500, label: '1 - 500 ft', colorClass: 'altitude-level-1', colorRgba: 'rgba(255, 204, 128, 0.8)' },      // Laranja claro
            { threshold: 1000, label: '501 - 1,000 ft', colorClass: 'altitude-level-2', colorRgba: 'rgba(255, 183, 77, 0.8)' },    // Laranja médio
            { threshold: 2000, label: '1,001 - 2,000 ft', colorClass: 'altitude-level-3', colorRgba: 'rgba(255, 241, 118, 0.8)' },   // Amarelo muito claro
            { threshold: 4000, label: '2,001 - 4,000 ft', colorClass: 'altitude-level-4', colorRgba: 'rgba(255, 238, 88, 0.8)' },    // Amarelo claro
            { threshold: 6000, label: '4,001 - 6,000 ft', colorClass: 'altitude-level-5', colorRgba: 'rgba(255, 235, 59, 0.8)' },    // Amarelo médio
            { threshold: 8000, label: '6,001 - 8,000 ft', colorClass: 'altitude-level-6', colorRgba: 'rgba(200, 230, 201, 0.8)' }, // Verde muito claro
            { threshold: 10000, label: '8,001 - 10,000 ft', colorClass: 'altitude-level-7', colorRgba: 'rgba(165, 214, 167, 0.8)' }, // Verde claro
            { threshold: 20000, label: '10,001 - 20,000 ft', colorClass: 'altitude-level-8', colorRgba: 'rgba(129, 199, 132, 0.8)' }, // Verde médio
            { threshold: 30000, label: '20,001 - 30,000 ft', colorClass: 'altitude-level-9', colorRgba: 'rgba(187, 222, 251, 0.8)' }, // Azul muito claro
            { threshold: 40000, label: '30,001 - 40,000 ft', colorClass: 'altitude-level-10', colorRgba: 'rgba(144, 202, 249, 0.8)' }, // Azul claro
            { threshold: Infinity, label: '> 40,000 ft', colorClass: 'altitude-level-11', colorRgba: 'rgba(248, 187, 208, 0.8)' },    // Rosa muito claro
            { threshold: null, label: 'Altitude Desconhecida', colorClass: 'altitude-unknown', colorRgba: 'rgba(240, 240, 240, 0.8)' } // Cinza claro
        ];

        // NOVO: Mapeia as classes de altitude para as cores RGBA para uso no JS
        const altitudeColorMap = {};
        altitudeRanges.forEach(range => {
            altitudeColorMap[range.colorClass] = range.colorRgba;
        });

        if (document.getElementById('map')) {
            map = L.map('map').setView([38.6892887, -9.311829], 10);

            aircraftMarkers = L.featureGroup().addTo(map);

            const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });
            osm.addTo(map);

            const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            const stadiaTerrain = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png?api_key=3f0a9b17-f599-4060-9407-966d99d13a94', {
                minZoom: 0,
                maxZoom: 18,
                attribution: '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            });

            const baseLayers = {
                "OpenStreetMap": osm,
                "Satélite (Esri)": esriSat,
                "Terreno (Stadia)": stadiaTerrain
            };

            L.control.layers(baseLayers).addTo(map);

        } else {
            console.error("Elemento 'map' não encontrado. Certifique-se de que a div com id='map' existe no HTML.");
        }

        const AIRCRAFT_ICON_URL = 'https://miguelt007.github.io/ads-b/plane.png';

        // Função para obter a classe de cor da altitude
        function getAltitudeColorClass(altitude) {
            if (altitude === null || isNaN(altitude)) {
                return 'altitude-unknown';
            }
            // Encontra a primeira faixa cujo threshold é maior ou igual à altitude
            for (const range of altitudeRanges) {
                if (range.threshold === null) continue; // Pula o desconhecido
                if (altitude <= range.threshold) {
                    return range.colorClass;
                }
            }
            return 'altitude-unknown'; // Fallback, embora Infinity deva cobrir todos os casos
        }

        // Função para exibir os dados na tabela e no mapa (agora recebe os dados já filtrados/ordenados)
        function displayAircrafts(aircraftsToDisplay) {
            const tableBody = document.getElementById('aircraftTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            aircraftMarkers.clearLayers();

            // Your table has 7 columns based on your provided HTML
            const numColumns = 7; 

            if (!aircraftsToDisplay || aircraftsToDisplay.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = numColumns; // Updated to 7 columns
                cell.textContent = "Nenhuma aeronave encontrada ou corresponde ao filtro.";
                cell.style.textAlign = "center";
                cell.style.color = "orange";
                return;
            }

            aircraftsToDisplay.forEach(aircraft => {
                const altitudeColorClass = getAltitudeColorClass(aircraft.alt_baro);

                const row = tableBody.insertRow();
                row.insertCell().textContent = aircraft.hex || 'N/A';
                row.insertCell().textContent = aircraft.flight ? aircraft.flight.trim() : 'N/A';
                row.insertCell().textContent = aircraft.r || 'N/A';
                row.insertCell().textContent = aircraft.t || 'N/A';
                row.insertCell().textContent = aircraft.alt_baro || 'N/A';
                row.insertCell().textContent = aircraft.gs || 'N/A';        
                row.insertCell().textContent = aircraft.type || 'N/A';
                row.classList.add(altitudeColorClass); // Add altitude color class to the table row

                if (map && aircraft.lat && aircraft.lon) {
                    const customAircraftDivIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `
                            <div class="aircraft-label-container" style="background-color: ${altitudeColorMap[altitudeColorClass]};">
                                <img src="${'https://miguelt007.github.io/ads-b/plane.png'}" alt="Avião" style="transform: rotate(${aircraft.track || 0}deg);">
                                <span class="flight-text">${aircraft.flight ? aircraft.flight.trim() : ''}</span>
                            </div>
                        `,
                        iconSize: [80, 24],
                        iconAnchor: [40, 12]
                    });

                    const marker = L.marker([aircraft.lat, aircraft.lon], {
                        icon: customAircraftDivIcon
                    }).addTo(aircraftMarkers);

                    marker.bindPopup(`
                        <b>Voo:</b> ${aircraft.flight ? aircraft.flight.trim() : 'N/A'}<br>
                        <b>Registro:</b> ${aircraft.r || 'N/A'}<br>
                        <b>Modelo:</b> ${aircraft.t || 'N/A'}<br>
                        <b>Altitude:</b> ${aircraft.alt_baro || 'N/A'} ft<br>
                        <b>Rumo:</b> ${aircraft.track || 'N/A'}°<br>
                        <b>Última Posição:</b> ${aircraft.seen_pos || 'N/A'} s<br>
                        <b>GS (kts):</b> ${aircraft.gs || 'N/A'}<br>
                        <br><a href="https://flightaware.com/live/flight/${aircraft.flight ? aircraft.flight.trim() : ''}" target="_blank">Ver no FlightAware</a>
                    `);
                }
            });

            if (map && aircraftMarkers.getLayers().length > 0) {
                map.fitBounds(aircraftMarkers.getBounds(), { padding: [50, 50] });
            }
        }

        function setupTableFilter() {
            const input = document.getElementById("tableFilter");
            input.addEventListener("keyup", function() {
                applyFiltersAndSort();
            });
        }

        function setupTableSorting() {
            const headers = document.querySelectorAll("#aircraftTable th");
            headers.forEach(header => {
                header.addEventListener("click", function() {
                    const column = this.getAttribute("data-column");

                    headers.forEach(h => {
                        if (h !== this) {
                            h.classList.remove('sort-asc', 'sort-desc');
                        }
                    });

                    if (currentSortColumn === column) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        currentSortDirection = 'asc';
                    }

                    this.classList.remove('sort-asc', 'sort-desc');
                    this.classList.add(`sort-${currentSortDirection}`);

                    applyFiltersAndSort();
                });
            });
        }

        function applyFiltersAndSort() {
            let filteredData = [...allAircraftData];

            const filterText = document.getElementById("tableFilter").value.toUpperCase();
            if (filterText) {
                filteredData = filteredData.filter(aircraft => {
                    return (aircraft.hex && String(aircraft.hex).toUpperCase().includes(filterText)) ||
                           (aircraft.type && String(aircraft.type).toUpperCase().includes(filterText)) ||
                           (aircraft.flight && String(aircraft.flight).toUpperCase().includes(filterText)) ||
                           (aircraft.r && String(aircraft.r).toUpperCase().includes(filterText)) ||
                           (aircraft.t && String(aircraft.t).toUpperCase().includes(filterText)) ||
                           (aircraft.gs && String(aircraft.gs).toUpperCase().includes(filterText)) ||
                           (aircraft.alt_baro && String(aircraft.alt_baro).toUpperCase().includes(filterText));
                });
            }

            if (currentSortColumn) {
                filteredData.sort((a, b) => {
                    const valA = a[currentSortColumn];
                    const valB = b[currentSortColumn];

                    if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB)) && typeof valA !== 'string' && typeof valB !== 'string') {
                        return currentSortDirection === 'asc' ? parseFloat(valA) - parseFloat(valB) : parseFloat(valB) - parseFloat(valA);
                    } else {
                        const strA = String(valA || '').toUpperCase();
                        const strB = String(valB || '').toUpperCase();
                        if (strA < strB) return currentSortDirection === 'asc' ? -1 : 1;
                        if (strA > strB) return currentSortDirection === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
            }

            displayAircrafts(filteredData);
        }

        
async function fetchAircraftData() {
    const tableBody = document.getElementById('aircraftTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Carregando dados...</td></tr>`; 

    try {
        // Agora, você chama a sua própria função serverless no Vercel
        const response = await fetch('/api/get-aircraft-data'); // Caminho para a sua função serverless

        if (!response.ok) {
            const errorResponse = await response.json(); // Assumindo que a função serverless retorna JSON em caso de erro
            throw new Error(`Erro ao buscar dados: ${errorResponse.error || 'Erro desconhecido.'}`);
        }

        const data = await response.json();
        console.log("Dados recebidos da API:", data);

        if (data && data.ac) {
            allAircraftData = data.ac;
            applyFiltersAndSort();
        } else {
            console.warn("API retornou dados em formato inesperado ou sem a propriedade 'ac':", data);
            allAircraftData = [];
            displayAircrafts([]);
        }

    } catch (error) {
        console.error('Erro ao buscar dados da API:', error);
        tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">Erro ao carregar dados: ${error.message}.</td></tr>`;
    }
}

        // Função para adicionar a legenda ao mapa
        function addLegendToMap() {
            const legend = L.control({ position: 'bottomright' }); // Posição da legenda no mapa

            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.innerHTML += '<h4>Altitude (ft)</h4>'; // Título da legenda

                // Iterate over altitude ranges and create legend items
                // Exclude the last item (Altitude Desconhecida) for the loop, add it separately
                for (let i = 0; i < altitudeRanges.length - 1; i++) {
                    const range = altitudeRanges[i];
                    // Format label to show range
                    let formattedLabel = range.label;
                    if (i === 0) { // Special case for 0 ft
                        formattedLabel = '0 ft';
                    } else if (range.threshold === Infinity) { // Special case for > max ft
                        formattedLabel = `> ${altitudeRanges[i-1].threshold} ft`;
                    } else { // Normal range
                        formattedLabel = `${(altitudeRanges[i-1].threshold + 1).toLocaleString()} - ${range.threshold.toLocaleString()} ft`;
                    }
                    div.innerHTML +=
                        '<i style="background:' + range.colorRgba + '"></i> ' + // Color sample
                        formattedLabel + '<br>'; // Range text
                }
                // Add the unknown altitude item
                const unknownRange = altitudeRanges[altitudeRanges.length - 1];
                div.innerHTML +=
                     '<i style="background:' + unknownRange.colorRgba + '"></i> ' + // Color sample
                     unknownRange.label + '<br>'; // Range text
                return div;
            };

            legend.addTo(map);
        }

        // Chamar as funções quando a página carregar
        if (map) {
            fetchAircraftData();
            setupTableFilter();
            setupTableSorting();
            addLegendToMap();
            setInterval(fetchAircraftData, 30000);
        }
    </script>
</body>
</html>
